<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ…skaitÅ³ skaitytuvas | Pelningas.lt</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- SheetJS library for Excel generation -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Authentication Check -->
    <script>
        // Patikrinti autentifikacijÄ… prieÅ¡ Ä¯keliant puslapÄ¯
        (function() {
            function isAuthenticated() {
                const localData = localStorage.getItem('invoice_auth');
                const sessionData = sessionStorage.getItem('invoice_auth');
                const authData = localData || sessionData;
                
                if (!authData) return false;

                try {
                    const parsed = JSON.parse(authData);
                    const now = Date.now();
                    const elapsed = now - parsed.timestamp;

                    if (elapsed < parsed.expiresIn) {
                        return true;
                    }

                    // Sesija pasibaigÄ—
                    localStorage.removeItem('invoice_auth');
                    sessionStorage.removeItem('invoice_auth');
                    return false;
                } catch (e) {
                    return false;
                }
            }

            // Jei neprisijungÄ™s - redirect Ä¯ auth
            if (!isAuthenticated()) {
                window.location.href = 'auth.html';
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="logo">Pelningas.lt</div>
                <button class="btn-logout" id="logout-btn" title="Atsijungti">
                    <span id="username-display"></span> | Atsijungti
                </button>
            </div>
            <h1>SÄ…skaitÅ³ skaitytuvas</h1>
            <p class="subtitle">Ä®kelkite sÄ…skaitas ir gaukite duomenis automatiÅ¡kai</p>
        </header>

        <!-- Upload Section -->
        <section id="upload-section" class="card">
            <div class="upload-zone" id="upload-zone">
                <div class="upload-icon">ğŸ“„</div>
                <h3>Ä®kelkite sÄ…skaitas</h3>
                <p>Nutempkite failus Äia arba</p>
                <button class="btn btn-secondary" id="browse-btn">Pasirinkite failus</button>
                <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png,.pdf" hidden>
                <p class="file-types">Priimami formatai: JPG, PNG, PDF (max 10MB)</p>
            </div>

            <!-- Preview uploaded files -->
            <div id="file-preview" class="file-preview hidden">
                <h4>Pasirinkti failai:</h4>
                <ul id="file-list"></ul>
            </div>

            <!-- Additional fields -->
            <div class="form-fields">
                <div class="form-group">
                    <label for="employee">Darbuotojo vardas pavardÄ—</label>
                    <input type="text" id="employee" placeholder="pvz. Jonas Jonaitis">
                </div>
                <div class="form-group">
                    <label for="saleCorAcc">DK sÄ…skaita</label>
                    <input type="text" id="saleCorAcc" placeholder="500101" value="500101">
                </div>
            </div>

            <button class="btn btn-primary btn-lg" id="submit-btn" disabled>
                ğŸš€ Apdoroti sÄ…skaitas
            </button>
        </section>

        <!-- Processing Section -->
        <section id="processing-section" class="card hidden">
            <div class="processing">
                <div class="spinner"></div>
                <h3>Apdorojamos sÄ…skaitos...</h3>
                <p id="processing-status">Nuskaitomas tekstas...</p>
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="card hidden">
            <div class="results-header">
                <div class="success-badge">
                    <span class="icon">âœ…</span>
                    <span>SÄ…skaitos sÄ—kmingai nuskaitytos!</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">SÄ…skaitÅ³</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-amount">0.00 â‚¬</div>
                    <div class="stat-label">Bendra suma</div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-wrapper">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Serija</th>
                            <th>Numeris</th>
                            <th>Klientas</th>
                            <th>Ä®m. kodas</th>
                            <th>Darbuotojas</th>
                            <th>Suma</th>
                            <th>PVM</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <!-- DinamiÅ¡kai generuojama -->
                    </tbody>
                </table>
            </div>

            <!-- Action Buttons -->
            <div class="actions">
                <a href="#" id="sheet-link" target="_blank" class="btn btn-secondary">
                    ğŸ“Š Atidaryti Google Sheet
                </a>
                <button class="btn btn-primary" id="csv-btn">
                    ğŸ“¥ Eksportuoti Excel
                </button>
                <button class="btn btn-outline" id="reset-btn">
                    ğŸ”„ Ä®kelti naujas
                </button>
            </div>
        </section>

        <!-- Error Section -->
        <section id="error-section" class="card card-error hidden">
            <div class="error-content">
                <span class="error-icon">âŒ</span>
                <h3>Ä®vyko klaida</h3>
                <p id="error-message"></p>
                <button class="btn btn-secondary" id="retry-btn">Bandyti dar kartÄ…</button>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Â© 2025 Pelningas.lt | SÄ…skaitÅ³ skaitytuvas</p>
        </footer>
    </div>

    <script src="js/app.js"></script>
</body>
</html>
